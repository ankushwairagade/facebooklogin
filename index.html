<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Signup & Send</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; }
    #status { margin-top: 20px; white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>WhatsApp Embedded Signup</h1>
  <button id="startBtn">Start Signup</button>
  <button id="sendBtn" disabled>Send Message</button>
  <div id="status"></div>

  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"></script>

  <script>
    // --- Configuration ---
    const FB_APP_ID        = '665303969425082';
    const FB_CONFIG_ID     = '9698426723575894';
    const BACKEND_URL      = 'https://facebooklogin-phi.vercel.app';
    const RECIPIENT_NUMBER = '+917276517716';

    // --- UI Elements & State ---
    const startBtn = document.getElementById('startBtn');
    const sendBtn  = document.getElementById('sendBtn');
    const status   = document.getElementById('status');

    let signupCode;
    let phoneNumberId;

    function log(msg) {
      console.log(msg);
      status.textContent += msg + '\n';
    }

    // Initialize Facebook SDK
    window.fbAsyncInit = () => {
      FB.init({ appId: FB_APP_ID, version: 'v22.0', xfbml: false });
      log('‚úÖ FB SDK initialized');
    };

    // 1Ô∏è‚É£ Start Embedded Signup
    startBtn.onclick = () => {
      startBtn.disabled = true;
      log('üîÑ Opening Embedded Signup');

      FB.ui({
        method: 'whatsapp_business_signup',
        config_id: FB_CONFIG_ID,
        response_type: 'code',
        redirect_uri: window.location.origin
      }, response => {
        if (!response || !response.code || !response.phone_number_id) {
          log('‚ùå Signup canceled or failed');
          startBtn.disabled = false;
          return;
        }
        signupCode    = response.code;
        phoneNumberId = response.phone_number_id;
        log(`‚úÖ Received code: ${signupCode}`);
        log(`‚úÖ Received phone_number_id: ${phoneNumberId}`);
        sendBtn.disabled = false;
        startBtn.disabled = false;
      });
    };

    // 2Ô∏è‚É£ Send WhatsApp Text Message
    sendBtn.onclick = async () => {
      if (!signupCode || !phoneNumberId) {
        log('‚ùå Missing signup data');
        return;
      }
      sendBtn.disabled = true;
      log('üîÑ Sending message via backend');

      try {
        const res = await fetch(`${BACKEND_URL}/send_message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: signupCode, phone_number_id: phoneNumberId })
        });
        const data = await res.json();
        log(`‚¨ÖÔ∏è HTTP ${res.status}`);
        if (!res.ok) throw new Error(data.error || 'Error sending message');
        log(`‚úÖ Message sent: ${JSON.stringify(data)}`);
      } catch (err) {
        log(`‚ùå ${err.message}`);
      } finally {
        sendBtn.disabled = false;
      }
    };
  </script>
</body>
</html>