<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Embedded Signup</title>
  <style>
    button {
      background-color: #1877f2;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-family: Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      height: 40px;
      padding: 0 24px;
    }
    pre {
      background: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="fb-root"></div>
  <button id="fb-login-btn">Login with Facebook</button>

  <p>Session info response:</p>
  <pre id="session-info-response"></pre>

  <p>SDK response:</p>
  <pre id="sdk-response"></pre>

  <p>Access Token response:</p>
  <pre id="token-response"></pre>

  <script>
    // —————— Configuration ——————
    const FB_APP_ID      = '665303969425082';
    const FB_CONFIG_ID   = '9698426723575894';
    const FB_SDK_VERSION = 'v22.0';
    // const REDIRECT_URI   = encodeURIComponent('https://your.backend.com/facebook/callback');
        const REDIRECT_URI  = encodeURIComponent('https://spiny-good-deltadromeus.glitch.me/webhook');

    // Your backend endpoint should accept `code` and `redirect_uri`, swap with client_secret server-side,
    // then return JSON { access_token, token_type, expires_in, ... }.

    // —————— Cache DOM nodes ——————
    const els = {
      session: document.getElementById('session-info-response'),
      sdk:     document.getElementById('sdk-response'),
      token:   document.getElementById('token-response'),
      button:  document.getElementById('fb-login-btn'),
    };

    // —————— Load FB SDK once ——————
    function loadFacebookSDK() {
      if (window.FB) return Promise.resolve(window.FB);
      return new Promise(resolve => {
        window.fbAsyncInit = () => {
          FB.init({
            appId:            FB_APP_ID,
            autoLogAppEvents: true,
            xfbml:            false,
            version:          FB_SDK_VERSION
          });
          resolve(FB);
        };
        const script = document.createElement('script');
        script.src = 'https://connect.facebook.net/en_US/sdk.js';
        script.async = true;
        document.head.appendChild(script);
      });
    }

    // —————— Exchange `code` for Access Token (via your backend) ——————
    async function swapCodeForToken(code) {
      const resp = await fetch(`/api/facebook/exchange?code=${code}&redirect_uri=${REDIRECT_URI}`);
      if (!resp.ok) throw new Error(`Token exchange failed (${resp.status})`);
      return resp.json();
    }

    // —————— Handle FB.login callback ——————
    async function fbLoginHandler(response) {
      els.sdk.textContent = JSON.stringify(response, null, 2);

      const code = response.authResponse?.code;
      if (!code) return;

      try {
        const tokenData = await swapCodeForToken(code);
        els.token.textContent = JSON.stringify(tokenData, null, 2);
      } catch (err) {
        console.error('Token exchange failed:', err);
        els.token.textContent = `Error: ${err.message}`;
      }
    }

    // —————— Kick off login flow ——————
    async function launchWhatsAppSignup() {
      await loadFacebookSDK();

      // FB.login requires a plain function, not async
      FB.login(
        function(response) {
          fbLoginHandler(response);
        },
        {
          config_id:                       FB_CONFIG_ID,
          response_type:                  'code',
          override_default_response_type: true,
          extras: {
            setup: {},
            sessionInfoVersion: '3'
          }
        }
      );
    }

    // —————— Wire up button ——————
    els.button.addEventListener('click', launchWhatsAppSignup);

    // —————— Listen for WA_EMBEDDED_SIGNUP postMessages ——————
    window.addEventListener('message', event => {
      const { origin, data } = event;
      if (!['https://www.facebook.com','https://web.facebook.com'].includes(origin)) return;
      try {
        const msg = JSON.parse(data);
        if (msg.type === 'WA_EMBEDDED_SIGNUP') {
          els.session.textContent = JSON.stringify(msg, null, 2);
          if (msg.event === 'FINISH') {
            console.log('✅ Signup finished:', msg.data);
          } else if (msg.event === 'CANCEL') {
            console.warn('⚠️ Cancelled at:', msg.data.current_step);
          } else if (msg.event === 'ERROR') {
            console.error('❌ Error:', msg.data.error_message);
          }
        }
      } catch {
        // ignore non-JSON messages
      }
    });
  </script>
</body>
</html>
