<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatsApp Signup & Send</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #status { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>WhatsApp Embedded Signup</h1>
  <button id="actionBtn">Start Signup & Send</button>
  <div id="status"></div>

  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js"></script>

  <script>
    // --- Configuration ---
    const FB_APP_ID    = '665303969425082';
    const FB_CONFIG_ID = '9698426723575894';
    const BACKEND_URL  = 'https://facebooklogin-phi.vercel.app';

    // --- UI & State ---
    const btn    = document.getElementById('actionBtn');
    const status = document.getElementById('status');

    function log(msg) {
      console.log(msg);
      status.textContent += msg + '
';
    }

    // Initialize FB SDK
    window.fbAsyncInit = () => {
      FB.init({ appId: FB_APP_ID, version: 'v22.0', xfbml: false });
      log('✅ FB SDK initialized');
    };

    // On button click, open WhatsApp Embedded Signup UI via FB.ui
    btn.onclick = () => {
      btn.disabled = true;
      log('🔄 Opening WhatsApp Embedded Signup...');

      FB.ui({
        method: 'whatsapp_business_signup',
        config_id: FB_CONFIG_ID,
        response_type: 'code',
        redirect_uri: window.location.origin
      }, async response => {
        log('📥 Signup callback: ' + JSON.stringify(response));
        if (!response || !response.code || !response.phone_number_id) {
          log('❌ Signup failed or canceled');
          btn.disabled = false;
          return;
        }
        const { code, phone_number_id } = response;
        log(`✅ Received code: ${code}`);
        log(`✅ Received phone_number_id: ${phone_number_id}`);

        // Call backend to exchange code & send message
        try {
          log('🔄 Calling backend to send message');
          const res = await fetch(BACKEND_URL + '/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, phone_number_id })
          });
          log('⬅️ HTTP ' + res.status);
          const data = await res.json();
          log('📦 Backend response: ' + JSON.stringify(data));
          if (!res.ok) throw new Error(data.error || 'Backend failed');
          log('✅ Message sent successfully');
        } catch (err) {
          log('❌ Backend error: ' + err.message);
        } finally {
          btn.disabled = false;
        }
      });
    };
  </script>
</body>
</html>